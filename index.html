<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaceHub</title>
    <link rel="icon" type="image/png" href="RaceHub.png">
    <style>
        :root {
            --bg: #08080c;
            --glass: rgba(20, 20, 28, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-pure: #ffffff;
            --text-dim: #94a3b8;
            --f1: #ff1801; --motogp: #ff6600; --dtm: #fbff00; --imsa: #15ff00; --wec: #00aeff;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text-pure); min-height: 100vh; padding-bottom: 50px; overflow-x: hidden; }

        header { text-align: center; padding: 40px 20px; animation: fadeInDown 0.8s ease-out; }
        
        .logo-container { margin-bottom: 15px; }
        .main-logo { 
            height: 70px; 
            width: auto; 
            filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.2));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .main-logo:hover { transform: scale(1.1) rotate(-2deg); }

        /* --- ESTILO DEL MENSAJE DE ADVERTENCIA (EST√ÅTICO) --- */
        .racehub-announcement {
            max-width: 900px;
            margin: 0 auto 25px;
            background: linear-gradient(90deg, rgba(255, 24, 1, 0.2) 0%, rgba(255, 24, 1, 0.05) 100%);
            border-left: 4px solid var(--f1);
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: fadeIn 1s ease;
        }

        .announcement-tag {
            background: var(--f1);
            color: white;
            font-size: 0.7rem;
            font-weight: 900;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .announcement-text {
            font-size: 0.9rem;
            color: #eee;
            line-height: 1.4;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .countdown-container {
            background: var(--glass); border: 1px solid var(--f1);
            display: inline-block; padding: 15px 30px; border-radius: 12px;
            box-shadow: 0 0 20px rgba(255, 24, 1, 0.1); margin-top: 15px;
            transition: transform 0.3s ease;
        }
        .countdown-container:hover { transform: scale(1.02); }

        #timer { font-family: monospace; font-size: 1.5rem; letter-spacing: 2px; }

        .controls { max-width: 900px; margin: 0 auto 30px; padding: 0 20px; text-align: center; animation: fadeIn 1s ease-in; }

        .search-bar {
            width: 100%; background: var(--glass); border: 1px solid var(--glass-border);
            padding: 12px 20px; border-radius: 30px; color: white; margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .search-bar:focus { outline: none; border-color: var(--f1); box-shadow: 0 0 15px rgba(255, 24, 1, 0.2); }

        .filter-btn {
            background: var(--glass); border: 1px solid var(--glass-border);
            color: var(--text-dim); padding: 8px 18px; border-radius: 20px;
            cursor: pointer; font-size: 0.8rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin: 2px;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .filter-btn.active { background: white; color: black; font-weight: bold; border-color: white; transform: scale(1.05); }

        .nav-arrow {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: white; width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; font-size: 1.2rem;
        }
        .nav-arrow:hover { background: white; color: black; transform: scale(1.1); }

        main { max-width: 900px; margin: 0 auto; padding: 0 20px; }

        .card {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px; margin-bottom: 12px;
            display: grid; grid-template-columns: 5px 1fr auto; gap: 20px;
            align-items: center; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0; animation: slideInRight 0.5s forwards;
        }
        .card:hover { 
            transform: translateX(10px); 
            background: rgba(30, 30, 40, 0.95);
            border-color: rgba(255,255,255,0.3);
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .cat-line { width: 5px; height: 40px; border-radius: 10px; }
        .time-box { text-align: right; font-weight: bold; }

        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; animation: fadeIn 0.5s ease; }
        
        .day {
            background: var(--glass); aspect-ratio: 1/1; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;
        }
        .day:hover { 
            background: rgba(255,255,255,0.1); 
            border-color: white; 
            transform: scale(1.1); 
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .dot { width: 6px; height: 6px; border-radius: 50%; margin: 1px; animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(0px); z-index: 3000; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .modal.active { display: flex; backdrop-filter: blur(15px); background: rgba(0,0,0,0.85); }

        .modal-content { 
            background: #111; padding: 30px; border-radius: 24px; width: 90%; max-width: 500px; 
            transform: scale(0.8); opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--glass-border);
        }
        .modal.active .modal-content { transform: scale(1); opacity: 1; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .bg-f1 { background: var(--f1); } .bg-motogp { background: var(--motogp); }
        .bg-dtm { background: var(--dtm); } .bg-imsa { background: var(--imsa); }
        .bg-wec { background: var(--wec); }
    </style>
</head>
<body>

<header>
  <div class="logo-container">
        <img src="RaceHub.png" alt="Logo" class="main-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/5602/5602690.png'">
  </div>
    <h1>RaceHub</h1>
    <div class="countdown-container">
        <div id="next-race-name" style="font-size: 0.9rem; margin-bottom: 5px; color: var(--text-dim);">Conectando con Neon...</div>
        <div id="timer">00d 00h 00m 00s</div>
    </div>
</header>

<div class="racehub-announcement">
    <span class="announcement-tag">Aviso</span>
    <p class="announcement-text">
        üö® <strong>IMPORTANTE:</strong> Los horarios han sido buscados con IA y estan en proceso de revisi√≥n. Algunos pueden ser erroneos a fecha de hoy solo la f1 ha sido revisada hasta el 19 de julio. 
    </p>
</div>
    
<div class="controls">
    <input type="text" id="search" class="search-bar" placeholder="Buscar GP o Categor√≠a...">
    <div id="filter-container">
        <button class="filter-btn active" data-cat="all">Todos</button>
        <button class="filter-btn" data-cat="F1">F1</button>
        <button class="filter-btn" data-cat="MotoGP">MotoGP</button>
        <button class="filter-btn" data-cat="WEC">WEC</button>
        <button class="filter-btn" data-cat="IMSA">IMSA</button>
        <button class="filter-btn" data-cat="DTM">DTM</button>
    </div>
    <div style="margin-top: 15px;">
        <button id="view-list-btn" class="filter-btn active">Lista</button>
        <button id="view-cal-btn" class="filter-btn">Calendario</button>
    </div>
</div>

<main>
    <section id="view-list"></section>
    <section id="view-calendar" style="display:none;">
        <div class="calendar-nav">
            <button id="prevMonth" class="nav-arrow">‚Äπ</button>
            <h2 id="month-label" style="text-transform: capitalize;"></h2>
            <button id="nextMonth" class="nav-arrow">‚Ä∫</button>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
    </section>
</main>

<div class="modal" id="modal">
    <div class="modal-content">
        <h2 id="modal-date" style="margin-bottom:20px; border-bottom: 1px solid #333; padding-bottom: 10px;"></h2>
        <div id="modal-events"></div>
        <button class="filter-btn active" onclick="closeModal()" style="width: 100%; margin-top: 20px; padding: 12px;">Cerrar</button>
    </div>
</div>

<script>
    // Inicializaci√≥n de variables
    let events = [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let filter = 'all';

    // --- L√ìGICA DE BACKEND (NETLIFY + NEON) ---
    async function loadEventsFromDB() {
        const loadingMsg = document.getElementById('next-race-name');
        
        try {
            // Llamada a la Netlify Function que conecta con Neon
            const response = await fetch('/.netlify/functions/get_races');
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            events = await response.json();
            
            // Actualizar interfaz con los nuevos datos
            console.log("Eventos cargados desde Neon:", events.length);
            loadingMsg.innerText = "Calculando pr√≥xima carrera...";
            renderList();
            renderCalendar();
            updateCountdown();
        } catch (error) {
            console.error("Error cargando eventos:", error);
            loadingMsg.innerText = "Error: No se pudo conectar a la base de datos.";
        }
    }

    // --- FUNCIONES DE UTILIDAD ---
    function parseEventDate(str) {
        if (!str) return new Date();
        // Soporte para fechas ISO (DB) y formato simple
        let datePart = str.includes('T') ? str.split('T')[0] : str;
        return new Date(datePart + "T00:00:00");
    }

    // --- RENDERIZADO (LISTA) ---
    function renderList() {
        const list = document.getElementById('view-list');
        const searchTerm = document.getElementById('search').value.toLowerCase();
        list.innerHTML = "";

        if (events.length === 0) {
            list.innerHTML = "<p style='text-align:center; padding:20px; color:var(--text-dim)'>Cargando eventos...</p>";
            return;
        }

        const filtered = events.filter(ev => {
            const matchesFilter = filter === 'all' || ev.series === filter;
            const matchesSearch = ev.name.toLowerCase().includes(searchTerm) || ev.series.toLowerCase().includes(searchTerm);
            return matchesFilter && matchesSearch;
        }).sort((a,b) => parseEventDate(a.date) - parseEventDate(b.date));

        filtered.forEach((ev, index) => {
            const d = parseEventDate(ev.date);
            // Comprobaci√≥n segura de si tiene hora asignada
            const hasTime = ev.date.includes("T") && !ev.date.includes("Sin hora");
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${Math.min(index * 0.05, 1)}s`;
            
            card.innerHTML = `
                <div class="cat-line bg-${ev.series.toLowerCase()}"></div>
                <div class="info">
                    <p style="color:var(--${ev.series.toLowerCase()}); font-weight:bold; font-size:0.7rem;">${ev.series}</p>
                    <h3>${ev.name}</h3>
                    <p style="color:var(--text-dim); font-size:0.85rem;">${ev.type}</p>
                </div>
                <div class="time-box">
                    <div class="date">${d.getDate()} ${d.toLocaleString('es', {month:'short'})}</div>
                    <div class="hour" style="color:var(--text-dim); font-size:0.9rem;">
                        ${hasTime ? new Date(ev.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'TBD'}
                    </div>
                </div>
            `;
            list.appendChild(card);
        });
    }

    // --- RENDERIZADO (CALENDARIO) ---
    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        const label = document.getElementById('month-label');
        grid.innerHTML = "";
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        label.innerText = new Date(currentYear, currentMonth).toLocaleString('es', {month:'long', year:'numeric'});

        // Ajuste para Lunes = primer d√≠a (Opcional, aqu√≠ Domingo=0 es est√°ndar JS)
        let gaps = firstDay === 0 ? 6 : firstDay - 1;
        
        for(let i=0; i<gaps; i++) grid.appendChild(document.createElement('div'));

        for(let d=1; d<=daysInMonth; d++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            dayDiv.style.animation = `fadeIn 0.3s ease forwards ${Math.min(d * 0.02, 0.5)}s`;
            dayDiv.innerHTML = `<span style="font-size:0.9rem; margin-bottom:4px;">${d}</span>`;
            
            const dayEvents = events.filter(ev => {
                const date = parseEventDate(ev.date);
                return date.getDate() === d && date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            if(dayEvents.length > 0) {
                const dots = document.createElement('div');
                dots.style.display = 'flex';
                dayEvents.forEach(e => {
                    const dot = document.createElement('div');
                    dot.className = `dot bg-${e.series.toLowerCase()}`;
                    dots.appendChild(dot);
                });
                dayDiv.appendChild(dots);
                dayDiv.onclick = () => openModal(dayEvents, d);
            }
            grid.appendChild(dayDiv);
        }
    }

    // --- CUENTA ATR√ÅS ---
    function updateCountdown() {
        if (events.length === 0) return;

        const now = new Date();
        const next = events
            .filter(ev => {
                // Filtramos eventos pasados o sin hora
                if(ev.date.includes("Sin hora")) return false;
                return new Date(ev.date) >= now && ev.type === "Race";
            })
            .sort((a,b) => new Date(a.date) - new Date(b.date))[0];

        if(!next) {
            document.getElementById('next-race-name').innerText = "No hay m√°s carreras programadas";
            document.getElementById('timer').innerText = "--d --h --m --s";
            return;
        }

        document.getElementById('next-race-name').innerText = `Pr√≥xima: ${next.series} - ${next.name}`;
        
        const target = new Date(next.date);
        const diff = target - now;
        
        if (diff <= 0) {
            document.getElementById('timer').innerText = "EN VIVO";
            return;
        }

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('timer').innerText = `${d}d ${h}h ${m}m ${s}s`;
    }

    // --- MODALES ---
    function openModal(evs, d) {
        const modal = document.getElementById('modal');
        document.getElementById('modal-date').innerText = `${d} de ${new Date(currentYear, currentMonth).toLocaleString('es',{month:'long'})}`;
        
        document.getElementById('modal-events').innerHTML = evs.map(ev => `
            <div class="card" style="opacity:1; margin-bottom:10px; grid-template-columns: 5px 1fr auto; animation: slideInRight 0.4s ease forwards;">
                <div class="cat-line bg-${ev.series.toLowerCase()}"></div>
                <div class="info">
                    <h3 style="font-size:1.1rem;">${ev.series}</h3>
                    <p style="color:var(--text-dim);">${ev.name}</p>
                </div>
                <div class="time-box" style="font-size:0.9rem;">
                    ${ev.date.includes("T") && !ev.date.includes("Sin") ? ev.date.split("T")[1].substring(0,5) : "TBD"}
                </div>
            </div>
        `).join('');

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeModal() { 
        const modal = document.getElementById('modal');
        modal.classList.remove('active');
        setTimeout(() => { if(!modal.classList.contains('active')) modal.style.display = 'none'; }, 300);
    }

    // --- EVENT LISTENERS ---
    document.getElementById('search').oninput = renderList;
    document.querySelectorAll('.filter-btn[data-cat]').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.filter-btn[data-cat]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filter = btn.dataset.cat;
            renderList();
        };
    });

    document.getElementById('view-list-btn').onclick = () => {
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-calendar').style.display = 'none';
        document.getElementById('view-list-btn').classList.add('active');
        document.getElementById('view-cal-btn').classList.remove('active');
        renderList();
    };

    document.getElementById('view-cal-btn').onclick = () => {
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-calendar').style.display = 'block';
        document.getElementById('view-cal-btn').classList.add('active');
        document.getElementById('view-list-btn').classList.remove('active');
        renderCalendar();
    };

    document.getElementById('prevMonth').onclick = () => { 
        currentMonth--; 
        if(currentMonth<0){currentMonth=11;currentYear--;} 
        renderCalendar(); 
    };
    document.getElementById('nextMonth').onclick = () => { 
        currentMonth++; 
        if(currentMonth>11){currentMonth=0;currentYear++;} 
        renderCalendar(); 
    };

    // --- INICIO ---
    setInterval(updateCountdown, 1000);
    
    // Aqu√≠ es donde sucede la magia: Cargamos los datos de Neon al iniciar
    loadEventsFromDB();

</script>
</body>

</html>



